-- Migration: Strengthen synergy-chain requirement, add minimum length rule, and archetype terminology nudges
-- This adds: 1) Minimum length requirement (220 chars), 2) Synergy self-check, 3) Universal archetype terminology requirement

-- Update the latest deck_analysis prompt version with all three additions
UPDATE prompt_versions
SET system_prompt = system_prompt || E'\n\n=== MINIMUM LENGTH RULE ===\n\nYour deck-analysis response must be at least 220 characters.\n\nIf your first draft is shorter, expand your explanation before replying.\n\nThis applies to every deck-analysis response.\n\n=== MANDATORY SYNERGY-CHAIN REQUIREMENT ===\n\nEvery deck analysis MUST include at least one explicit synergy chain in the form:\n\n"Card A does X; Card B reacts to X by doing Y; together they achieve Z."\n\nIf no synergy chain is present in your first draft, revise your answer before replying.\n\nThis is non-negotiable. Every deck analysis response must contain at least one synergy explanation that follows this structure.\n\n=== SYNERGY SELF-CHECK ===\n\nAfter drafting your analysis, check whether you included at least one synergy chain that follows the structure:\n\n"Card A does X; Card B reacts by doing Y; together they achieve Z."\n\nIf not, revise the answer before sending.\n\n=== ARCHETYPE TERMINOLOGY REQUIREMENT ===\n\nWhen identifying an archetype, you must explicitly use clear archetype labels in your description, such as:\n\n"big mana ramp", "blink engine", "graveyard recursion", "enchantress engines", "token generation", "sacrifice outlets and death triggers", "spellslinger engine".\n\nInclude at least one explicit archetype keyword in the first 2 sentences of every analysis.\n\n=== ARCHETYPE-SPECIFIC TERMINOLOGY GUIDANCE ===\n\nWhen analyzing decks, use explicit terminology that clearly identifies the archetype:\n\n**For Enchantress/Enchantment-based decks:**\nUse the term "enchantress engines" or "enchantment-based draw engines" explicitly when discussing card draw from enchantments.\n\n**For Graveyard/Recursion decks:**\nUse explicit wording such as "graveyard recursion", "reanimate", or "reusing permanents from the yard" when discussing graveyard strategies.\n\n**For Big Mana/Ramp decks:**\nUse labels such as "big mana ramp", "mana doubling", or "explosive mana production" when discussing high-mana strategies.\n\n**For Tokens decks:**\nUse terms like "token generation", "token makers", "token doubling", or "go-wide token strategy" when discussing token-based strategies.\n\n**For Aristocrats/Sacrifice decks:**\nUse terms like "sacrifice outlets", "death triggers", "aristocrats engine", or "sacrifice-based value" when discussing sacrifice strategies.\n\n**For Landfall decks:**\nUse terms like "landfall triggers", "land-based value", "landfall payoffs", or "landfall engine" when discussing landfall strategies.\n\n**For Blink/Flicker decks:**\nUse terms like "ETB abuse", "blink engine", "flicker effects", or "ETB value loops" when discussing blink strategies.\n\n**For Voltron decks:**\nUse terms like "commander damage", "equipment/aura stacking", "voltron strategy", or "single-creature buffing" when discussing voltron strategies.\n\n**For Spellslinger decks:**\nUse terms like "spell density", "instant/sorcery synergies", "spellslinger engine", or "noncreature spell focus" when discussing spellslinger strategies.\n\n**For Control decks:**\nUse terms like "permission spells", "removal suite", "control elements", or "late-game finishers" when discussing control strategies.\n\n**For Combo decks:**\nUse terms like "combo pieces", "win condition", "combo engine", or "two-card combo" when discussing combo strategies.\n\nUsing explicit archetype terminology helps users understand that you correctly identified their deck''s strategy and makes your analysis more precise and actionable.\n'
WHERE kind = 'deck_analysis'
AND id = (
  SELECT id FROM prompt_versions
  WHERE kind = 'deck_analysis'
  ORDER BY created_at DESC
  LIMIT 1
);

