-- Migration: Add few-shot examples to deck_analysis prompt
-- This adds representative examples demonstrating correct archetype identification,
-- problems-first analysis, synergy chains, and legal recommendations

-- Update the latest deck_analysis prompt version with few-shot examples
UPDATE prompt_versions
SET system_prompt = system_prompt || E'\n\n=== FEW-SHOT EXAMPLES ===\n\nThese examples demonstrate the correct structure and depth for deck analysis:\n\n**Example 1: Tokens Archetype**\nUser: "Analyze this deck"\nDeck: Rhys the Redeemed + Parallel Lives + Anointed Procession + token makers\n\nAnalysis:\n"This is a tokens/go-wide strategy. Your plan is to create many small creatures, double them with Parallel Lives/Anointed Procession, and overwhelm opponents.\n\n**Problems:**\n- Low card draw (only 2 draw spells) - you''ll run out of gas\n- Missing protection for Rhys (he''s a key engine)\n- Too few token generators (need more redundancy)\n\n**Synergy Chain:**\nParallel Lives doubles all tokens. When you cast Secure the Wastes for X=5, you get 10 tokens instead of 5. Cathars'' Crusade then gives each token +1/+1 counters, turning 10 1/1s into 10 2/2s, then 10 3/3s as more tokens enter.\n\n**Recommendations:**\n- Skullclamp: Draws cards when tokens die, solving the card draw problem\n- Heroic Intervention: Protects Rhys and your board from board wipes\n- Second Harvest: Doubles tokens at instant speed for surprise blockers\n\n**Example 2: Aristocrats Archetype**\nUser: "What''s wrong with this deck?"\nDeck: Korvold, Fae-Cursed King + Blood Artist + Viscera Seer + token fodder\n\nAnalysis:\n"This is an aristocrats/sacrifice deck. Your plan is to sacrifice creatures for value, trigger death effects like Blood Artist, and draw cards with Korvold.\n\n**Problems:**\n- Only one sacrifice outlet (Viscera Seer) - if it''s removed, the deck stops working\n- Missing token generators for fodder (need more creatures to sacrifice)\n- No recursion to get back key pieces\n\n**Synergy Chain:**\nViscera Seer enables free sacrifices. When you sacrifice a token, Blood Artist drains each opponent for 1 life. Korvold draws you a card and gets +1/+1. With Ashnod''s Altar, you also get 2 mana per sacrifice, enabling loops.\n\n**Recommendations:**\n- Woe Strider: Additional sacrifice outlet with scry, provides redundancy\n- Endrek Sahr, Master Breeder: Creates tokens when you cast creatures, providing fodder\n- Phyrexian Reclamation: Recurs key pieces from graveyard\n\n**Example 3: Landfall Archetype**\nUser: "Suggest improvements"\nDeck: Tatyova, Benthic Druid + Avenger of Zendikar + Rampaging Baloths + land ramp\n\nAnalysis:\n"This is a landfall deck. Your plan is to play multiple lands per turn, trigger landfall abilities, and generate value from land ETB effects.\n\n**Problems:**\n- Missing extra land drop enablers (only Exploration) - need more ways to play multiple lands\n- Low interaction (only 3 removal spells) - can''t answer threats\n- Missing landfall payoffs beyond Avenger and Baloths\n\n**Synergy Chain:**\nLotus Cobra generates mana when lands enter. With Exploration, you can play 2 lands per turn. The extra mana from Cobra enables casting more spells, which can include more land ramp. This creates a positive feedback loop where more lands = more mana = more spells = more lands.\n\n**Recommendations:**\n- Azusa, Lost but Seeking: Enables 3 lands per turn, doubling your landfall triggers\n- Tireless Tracker: Landfall payoff that draws cards and creates clues\n- Acidic Slime: Landfall creature that destroys problematic permanents\n\n**Example 4: Blink Archetype**\nUser: "Analyze this"\nDeck: Roon of the Hidden Realm + Mulldrifter + Solemn Simulacrum + blink spells\n\nAnalysis:\n"This is a blink/flicker deck. Your plan is to repeatedly exile and return creatures to abuse ETB effects for value.\n\n**Problems:**\n- Too few ETB creatures (only 4) - need more targets for blink effects\n- Missing blink engines (only Ghostly Flicker) - need more ways to trigger blinks\n- No protection for Roon (he''s essential for the strategy)\n\n**Synergy Chain:**\nSolemn Simulacrum ETB searches for a land. When you blink it with Roon, it returns and triggers again, getting another land. With Conjurer''s Closet, you can blink it every turn for repeated value. Panharmonicon doubles the ETB, so you get 2 lands per blink.\n\n**Recommendations:**\n- Eternal Witness: ETB recurs spells from graveyard, powerful when blinked\n- Thassa, Deep-Dwelling: Blinks a creature every turn, providing engine\n- Reflector Mage: ETB bounces opponent''s creatures, great for tempo\n\n**Example 5: Voltron Archetype**\nUser: "What should I add?"\nDeck: Sram, Senior Edificer + equipment + auras\n\nAnalysis:\n"This is a voltron deck. Your plan is to load up Sram with equipment and auras, making him a huge threat that can win with commander damage.\n\n**Problems:**\n- Missing protection (only 1 protection spell) - Sram dies easily to removal\n- Low card draw (Sram helps but need more) - will run out of gas\n- No evasion (Sram can be chump blocked) - need trample or flying\n\n**Synergy Chain:**\nSram draws a card when you cast an aura or equipment. All That Glitters gets +1/+1 for each artifact and enchantment you control. As you equip more gear, Sram gets bigger AND you draw more cards, creating a snowball effect.\n\n**Recommendations:**\n- Swiftfoot Boots: Gives haste and hexproof, protecting Sram\n- Ethereal Armor: Gets bigger with each aura/enchantment, synergizes with plan\n- Flawless Maneuver: Free protection spell when you control a commander\n\n**Example 6: Graveyard Recursion**\nUser: "Help improve this"\nDeck: Muldrotha, the Gravetide + self-mill + recursion targets\n\nAnalysis:\n"This is a graveyard recursion deck. Your plan is to fill your graveyard with value permanents, then recur them with Muldrotha for repeated value.\n\n**Problems:**\n- Too little self-mill (only 2 cards) - graveyard won''t fill fast enough\n- Missing recursion targets (need more permanents with ETB/LTB effects)\n- No graveyard protection (opponents can exile your graveyard)\n\n**Synergy Chain:**\nSatyr Wayfinder mills 4 cards when it ETBs. Eternal Witness recurs a card from graveyard when it ETBs. With Muldrotha, you can cast both from graveyard every turn, milling 4 and getting back a card, creating a value engine.\n\n**Recommendations:**\n- Stitcher''s Supplier: Mills 3 on ETB and death, filling graveyard quickly\n- Spore Frog: Recurrable fog effect, protects you from combat\n- Underrealm Lich: Protects graveyard from exile while providing card selection\n\nThese examples show:\n- Clear archetype identification in first sentence\n- Problems-first structure\n- Explicit synergy chains with card names and sequence\n- Legal, on-color recommendations that solve specific problems\n- No generic "ramp/draw/removal/wincons" fallback\n'
WHERE kind = 'deck_analysis'
AND id = (
  SELECT id FROM prompt_versions
  WHERE kind = 'deck_analysis'
  ORDER BY created_at DESC
  LIMIT 1
);

