name: WebSocket Security Check

on:
  pull_request:
    paths:
      - 'frontend/**/*.ts'
      - 'frontend/**/*.tsx'
      - 'frontend/**/*.js'
      - 'frontend/**/*.jsx'
  push:
    branches: [main]
    paths:
      - 'frontend/**/*.ts'
      - 'frontend/**/*.tsx'
      - 'frontend/**/*.js'
      - 'frontend/**/*.jsx'

jobs:
  check-insecure-websockets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check for insecure WebSocket protocols
        run: |
          echo "Checking for ws:// in client-side code (excluding tests and docs)..."
          
          # Check for ws:// in TypeScript/JavaScript files (excluding node_modules, tests, docs)
          if grep -r "ws://" frontend/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
            --exclude-dir=node_modules \
            --exclude-dir=.next \
            --exclude-dir=dist \
            --exclude-dir=docs \
            --exclude="*.test.ts" \
            --exclude="*.test.tsx" \
            --exclude="*.spec.ts" \
            --exclude="*.spec.tsx" \
            --exclude="*.test.js" \
            --exclude="*.spec.js"; then
            echo "❌ ERROR: Found ws:// in client-side code!"
            echo "Please use wss:// for production or use the secure-connections helper."
            echo "See frontend/lib/secure-connections.ts for secure connection utilities."
            exit 1
          fi
          
          echo "✅ No insecure ws:// protocols found in client-side code"
          
      - name: Verify secure-connections helper exists
        run: |
          if [ ! -f "frontend/lib/secure-connections.ts" ]; then
            echo "❌ ERROR: secure-connections.ts helper not found!"
            exit 1
          fi
          echo "✅ secure-connections.ts helper found"
